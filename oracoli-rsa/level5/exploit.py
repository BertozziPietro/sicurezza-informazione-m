import socket

HOST = "localhost"
PORT = 2005
s = socket.create_connection((HOST, PORT))


def recv_until(s, marker):
    data = b""
    while not data.endswith(marker):
        chunk = s.recv(1)
        if not chunk:
            break
        data += chunk
    return data.decode()

banner = recv_until(s, b"> ")
enc_flag_line = [line for line in banner.split("\n") if "Encrypted flag:" in line][0]
enc_flag = int(enc_flag_line.split(":")[1].strip())
print(f"Encrypted flag: {enc_flag}")

s.sendall(b"2\n")
recv_until(s, b"Ciphertext > ")
s.sendall(b"-1\n")
recv_until(s, b"\n")
dec_neg1 = int(recv_until(s, b"\n").strip().split()[-1])
n = dec_neg1 + 1

recv_until(s, b"> ")
s.sendall(b"2\n")
recv_until(s, b"Ciphertext > ")
s.sendall(f"{-enc_flag}\n".encode())
recv_until(s, b"\n")
dec_neg_flag = int(recv_until(s, b"\n").strip().split()[-1])

flag = n - dec_neg_flag
flag_str = flag.to_bytes((flag.bit_length() + 7) // 8, "big").decode()
print("Flag:", flag_str)
print("Exploit executed successfully.")
