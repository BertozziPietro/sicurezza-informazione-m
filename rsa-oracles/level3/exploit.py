import socket
from math import gcd

HOST = "localhost"
PORT = 2003
s = socket.create_connection((HOST, PORT))

def recv_until(marker):
    data = b""
    while not data.endswith(marker):
        data += s.recv(1)
    return data.decode()

e = 65537

banner = recv_until(b"> ")
enc_flag_line = [line for line in banner.split("\n") if "Encrypted flag:" in line][0]
enc_flag = int(enc_flag_line.split(":")[1].strip())
print(enc_flag_line)

s.sendall(b"1\n")
recv_until(b"Plaintext > ")
s.sendall(b"3\n")
recv_until(b"\n")
enc_3 = int(recv_until(b"\n").strip().split()[-1])

recv_until(b"> ")
s.sendall(b"1\n")
recv_until(b"Plaintext > ")
s.sendall(b"5\n")
recv_until(b"\n")
enc_5 = int(recv_until(b"\n").strip().split()[-1])

n = gcd(pow(3, e) - enc_3, pow(5, e) - enc_5)
p = 1337
p_inv = pow(p, -1, n)
c1 = (enc_flag * p_inv) % n

recv_until(b"> ")
s.sendall(b"2\n")
recv_until(b"Ciphertext > ")
s.sendall(f"{c1}\n".encode())
recv_until(b"\n")
m1 = int(recv_until(b"\n").strip().split()[-1])

recv_until(b"> ")
s.sendall(b"2\n")
recv_until(b"Ciphertext > ")
s.sendall(f"{p}\n".encode())
recv_until(b"\n")
m2 = int(recv_until(b"\n").strip().split()[-1])

flag = (m1 * m2) % n
flag_str = flag.to_bytes((flag.bit_length() + 7) // 8, "big").decode()
print("Flag:", flag_str)
print("Exploit executed successfully.")
