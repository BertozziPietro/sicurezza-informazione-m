import socket

HOST = "localhost"
PORT = 2001
s = socket.create_connection((HOST, PORT))

def recv_until(marker):
    data = b""
    while not data.endswith(marker):
        data += s.recv(1)
    return data.decode()

banner = recv_until(b"> ")
enc_flag_line = [line for line in banner.split("\n") if "Encrypted flag:" in line][0]
enc_flag = int(enc_flag_line.split(":")[1].strip())
print(enc_flag_line)

s.sendall(b"1\n")
recv_until(b"Plaintext > ")
s.sendall(b"2\n")
recv_until(b"\n")
response = recv_until(b"\n")
enc_2 = int(response.strip().split()[-1])

recv_until(b"> ")
s.sendall(b"2\n")
recv_until(b"Ciphertext > ")
s.sendall(f"{enc_flag * enc_2}\n".encode())
recv_until(b"\n")
response = recv_until(b"\n")
flag = int(response.strip().split()[-1]) // 2

flag_str = flag.to_bytes((flag.bit_length() + 7) // 8, "big").decode()
print("Flag:", flag_str)

recv_until(b"> ")
s.sendall(b"0\n")
print("Exploit executed successfully.")
s.close()
